# 个人订单管理需求文档

本文档详细描述了“个人订单管理”模块的功能需求、交互流程和边界场景。

## 1. 个人中心

### 1.1 订单管理列表页

**1.1.1 进入方式**

- 用户登录后，通过点击顶部导航栏中的“我的订单”入口，进入订单管理列表页。

**1.1.2 页面元素**

- **导航标签栏**:
    - “全部订单”标签
    - “未出行”标签
    - “待支付”标签
    - “待点评”标签
- **订单类型筛选下拉**:
    - “全部订单”、“机票”、“火车票”、“酒店”
- **订单卡片 (Order Card)**: 循环展示的订单基本信息单元。
    - 订单类型图标 (例如：飞机、酒店)
    - 产品标题 (例如：“张家界 → 慈利”)
    - 订单日期
    - 订单总金额
    - 订单状态 (例如：“已确认”、“待支付”、“已取消”)
    - “查看详情”按钮
    - “下载订单”按钮（导出 TXT）
- **顶部导航栏**: 显示当前登录用户名或手机号
- **空状态提示**: 当某个分类下无订单时显示的提示信息，如“您还没有相关订单哦”。
- **分页控件**: 当订单数量超过单页容量时，用于切换页面。
- **加载提示 (Loading Indicator)**: 进入页面或切换标签时，数据加载过程中显示的动画。
- **错误提示 (Error Message)**: 数据加载失败时显示的提示信息。

---

#### Scenario: 成功加载并显示全部订单列表
> 这是用户进入页面的主要正常流程。

    Given 用户已登录且拥有多个历史订单
    When 用户点击导航栏的“我的订单”
    Then 系统应跳转到订单管理列表页
    And “全部订单”标签应处于默认激活状态
    And 页面应显示一个加载提示
    And 加载成功后，系统应按订单创建时间倒序，分页展示用户的订单卡片列表

#### Scenario: 用户切换订单分类标签
> 正常流程，用户筛选不同状态的订单。

    Given 用户位于订单管理列表页
    When 用户点击“未出行”标签
    Then 系统应向服务器请求“未出行”状态的订单数据
    And 页面应显示一个加载提示
    And 加载成功后，列表应仅显示状态为“未出行”且支付成功/已出票的订单

#### Scenario: 用户按订单类型筛选（正常流程）
> 使用“订单类型”下拉框进行类型筛选。

    Given 用户位于订单管理列表页
    When 用户在“订单类型”下拉框选择“机票”/“火车票”/“酒店”
    Then 系统应向服务器请求附带 productType 的订单数据（例如 flight/train/hotel）
    And 加载成功后，列表应仅显示对应类型的订单

#### Scenario: 切换到“待支付”标签并操作支付
> 正常流程，用户查看待支付订单并进入支付。

    Given 用户位于订单管理列表页
    When 用户点击“待支付”标签
    Then 系统应加载所有待支付订单
    And 每条订单应展示金额与“去支付”入口
    When 用户点击某订单的“去支付”入口
    Then 系统应跳转到支付页面或弹出支付方式选择

#### Scenario: 用户没有任何订单 (状态异常)
> 边界情况，新用户或无订单用户访问。

    Given 一个已登录但从未下过单的用户
    When 用户进入订单管理列表页
    Then 系统应显示“您还没有相关订单哦”的空状态提示
    And 不应显示订单卡片和分页控件

#### Scenario: API请求失败或网络中断 (系统异常)
> 系统异常流程，处理后端服务不可用或网络问题。

    Given 用户正在访问订单管理列表页
    When 页面在请求订单数据时，服务器返回500错误或网络连接中断
    Then 页面应停止加载动画
    And 显示一个明确的错误提示，例如：“订单加载失败，请检查您的网络并重试”
    And 提供一个“重试”按钮，允许用户手动重新加载数据

#### Scenario: 用户尝试访问一个不存在的分页 (输入异常)
> 用户通过URL或伪造请求访问一个超出范围的页码。

    Given 用户的订单共有3页
    When 用户尝试通过修改URL参数访问第4页
    Then 系统应停留在最后一页（第3页）或第一页
    And 页面内容不应发生错误，不能显示空白或崩溃

---

### 1.2 订单详情页

**1.2.1 进入方式**

- 在订单管理列表页，点击任一订单卡片上的“查看详情”按钮。

**1.2.2 页面元素**

- **返回按钮**: 返回订单列表页。
- **顶部状态横幅**:
    - “支付成功”横幅，文案示例：“订单已支付成功，预计在X分钟内完成出票。”
    - “已取消”横幅，文案示例：“您的订单已取消，可选择携程重新预订。”并包含“重新下单”按钮。
- **车票信息卡片**:
    - 出发日期与星期、出发时间与车站
    - 车次号（示例：7266）、座席类型
    - 到达时间与车站
    - 乘客姓名与证件号（脱敏显示：如 430802**********12）
    - 当前票务状态标签（如：支付成功、已取消）
- **价格明细侧栏**:
    - “火车票”行：单价与张数（如：¥8.5×1张）
    - “附加服务”行：优惠券或增值服务（如：火车票价优惠券 -¥3）
    - “订单总额”行：合计金额（如：¥5.5）
- **操作区**:
    - “取消订单”按钮（状态受限）
    - “申请发票”按钮
    - “联系客服”按钮
    - “重新下单”按钮（用于已取消订单）
- **扫码取票组件**:
    - 微信二维码提示区，文案示例：“打开微信扫一扫，轻松查票，一键取票”
- **常见问题区**: 常见问题链接列表。

---

#### Scenario: 成功查看可取消订单的详情
> 正常流程，查看一个允许执行操作的订单。

    Given 用户在订单列表页，且列表中有一个“待出行”的机票订单
    When 用户点击该订单的“查看详情”按钮
    Then 系统应跳转到该机票订单的详情页
    And 页面应正确显示航班号、旅客信息、价格明细等所有相关信息
    And “取消订单”按钮应处于可用状态

#### Scenario: 支付成功详情展示与取票引导（正常流程）
> 展示支付成功横幅与扫码取票入口。

    Given 用户已完成支付并跳转到订单详情页
    Then 页面顶部应显示“支付成功”横幅及说明文案
    And 右侧价格明细应正确显示票价、优惠与订单总额
    And 页面应显示“微信扫一扫”二维码取票引导

#### Scenario: 已取消详情展示与重新下单入口（状态异常）
> 已取消订单的展示与操作限制。

    Given 用户查看一个已取消的订单详情
    Then 顶部应显示“已取消”横幅与提示文案
    And “取消订单”按钮不应显示或置灰不可用
    And 页面应显示“重新下单”按钮

#### Scenario: 价格明细计算校验失败（系统异常）
> 合计金额与明细不一致时的处理。

    Given 页面展示价格明细与订单总额
    When 系统检测到明细求和不等于订单总额
    Then 页面应显示“价格明细暂不可用，请稍后重试”的错误提示
    And 允许用户继续查看非价格相关信息

#### Scenario: 用户试图访问一个不属于自己的订单 (状态异常/权限异常)
> 异常流程，防止用户越权查看他人信息。

    Given 用户A已登录
    When 用户A通过拼接URL等方式，试图访问属于用户B的订单详情页
    Then 后端应进行权限校验并拒绝请求
    And 前端页面应显示“订单不存在或您没有权限查看”的错误信息
    And 提供一个返回“我的订单”列表页的链接

#### Scenario: 查看一个已过期的或不可操作的订单 (状态异常)
> 边界情况，订单状态决定了可执行的操作。

    Given 用户正在查看一个“已完成”或“已取消”的订单详情
    When 页面加载完成
    Then 页面应正确显示所有订单信息
    And “取消订单”按钮应处于置灰不可用状态或直接不显示

#### Scenario: 加载详情时API请求失败 (系统异常)
> 系统异常，处理后端服务或网络问题。

    Given 用户点击“查看详情”按钮
    When 详情页请求数据时，服务器无响应或返回错误
    Then 页面应显示一个覆盖性的错误提示，如：“订单详情加载失败，请稍后重试”
    And 提供一个“返回列表”的按钮和一个“重试”按钮

---

### 1.3 取消订单流程

**1.3.1 进入方式**

- 在订单详情页，点击“取消订单”按钮。

**1.3.2 页面元素**

- **确认弹窗 (Confirmation Modal)**:
    - 标题：取消订单
    - 文案：示例“点下去票就出不咯！你确定要取消订单吗？”
    - “取消订单”确认按钮
    - “点错了”按钮（或关闭图标）
- **成功提示 (Success Toast/Notification)**: 操作成功后的轻量级提示。
- **失败提示 (Failure Toast/Notification)**: 操作失败后的提示。

---

#### Scenario: 用户成功取消订单
> 正常流程，用户完成取消操作。

    Given 用户正在查看一个“待出行”且可被取消的订单详情
    When 用户点击“取消订单”按钮
    And 在弹出的确认窗口中点击“确认取消”
    Then 系统应向后端发送取消请求，并显示一个处理中的提示
    And 后端成功处理后，前端应收到成功响应
    And 页面显示“订单已成功取消”的提示
    And 订单详情页的状态更新为“已取消”，且“取消订单”按钮变为不可用

#### Scenario: 用户点击“点错了”放弃取消（输入异常）
> 用户在确认弹窗中取消操作。

    Given 取消确认弹窗已显示
    When 用户点击“点错了”按钮或关闭弹窗
    Then 弹窗关闭且不发出取消请求
    And 页面保持原有状态

#### Scenario: 取消订单需扣除手续费（状态异常）
> 根据供应商政策，取消需扣费。

    Given 订单处于可取消但需扣费的状态
    When 用户确认取消
    Then 后端应返回手续费金额与新合计
    And 前端在成功提示中展示“已取消，扣除手续费¥X”

#### Scenario: 取消请求网络超时（系统异常）
> 网络不稳定导致请求超时。

    Given 用户发起取消请求
    When 网络超时未得到响应
    Then 页面提示“网络异常，已为您保留订单状态”并提供“重试”按钮
    And 不应更新订单状态

#### Scenario: 出票中不可取消（状态异常）
> 出票流程进行中，暂不可取消。

    Given 订单状态为“出票中”
    When 用户点击取消并确认
    Then 后端返回“当前状态不可取消”
    And 前端提示“稍后再试或联系客服”

### 1.4 扫码取票

**1.4.1 进入方式**

- 在订单详情页，点击“微信扫一扫”引导或直接扫描页面展示的二维码。

**1.4.2 页面元素**

- 二维码图片与说明文案（“打开微信扫一扫，轻松查票，一键取票”）
- 可能的备用取票码展示与“复制取票码”按钮

#### Scenario: 成功扫码取票（正常流程）

    Given 用户在订单详情页
    When 用户使用微信扫描页面二维码
    Then 跳转至取票服务并完成取票
    And 页面提示“取票成功”

#### Scenario: 扫码失败或无摄像头权限（输入异常）

    Given 用户尝试扫码取票
    When 设备拒绝摄像头权限或扫码失败
    Then 页面提示“扫码失败，请检查权限或改用取票码”
    And 展示备用取票码与“复制取票码”按钮

#### Scenario: 订单未出票导致取票失败（状态异常）

    Given 订单仍处于“支付成功，待出票”状态
    When 用户尝试扫码取票
    Then 服务返回“订单未出票，稍后再试”
    And 页面提示并建议稍后再试或联系客服

#### Scenario: 取票服务不可用（系统异常）

    Given 用户扫码后进入第三方取票服务
    When 服务不可用或返回错误
    Then 页面提示“取票服务繁忙，请稍后重试”
    And 保持订单状态不变

### 1.5 订单下载/打印

**1.5.1 进入方式**

- 在订单列表页点击“下载订单”，或在订单详情页点击“下载订单”。

**1.5.2 页面元素**

- “下载订单”按钮与文件格式提示（TXT）
- 多选框（列表页支持勾选多个订单下载）（当前版本展示勾选项，批量下载暂未实现）

#### Scenario: 成功生成并下载订单TXT（正常流程）

    Given 用户在订单列表或详情页
    When 用户点击“下载”
    Then 系统生成电子票或行程单并开始下载
    And 文件包含订单号、出行信息、金额与状态

#### Scenario: 未选择任何订单（输入异常）

    Given 列表页支持多选下载
    When 用户点击“下载订单”但未勾选任何订单
    Then 页面提示“请先选择订单”

#### Scenario: 订单状态不支持下载（状态异常）

    Given 订单处于未支付或已取消且无行程单的状态
    When 用户点击“下载订单”
    Then 页面提示“当前状态不支持下载”

#### Scenario: 文件生成失败（系统异常）

    Given 用户请求下载文件
    When 文件生成服务返回错误
    Then 页面提示“生成失败，请稍后重试”并提供重试入口

### 1.6 重新下单

**1.6.1 进入方式**

- 在已取消订单的详情页点击“重新下单”。

**1.6.2 页面元素**

- “重新下单”按钮
- 预填充的搜索条件（出发地、到达地、日期/时间）

#### Scenario: 成功跳转并预填搜索（正常流程）

    Given 用户在已取消订单的详情页
    When 用户点击“重新下单”
    Then 系统跳转到搜索/预订页并预填原订单的出行信息

#### Scenario: 原订单日期已过期（输入异常）

    Given 原订单的出行日期已过去
    When 用户点击“重新下单”
    Then 系统提示“日期已过期，请选择新日期”并打开日期选择器

#### Scenario: 库存变化导致推荐变更（状态异常）

    Given 重新下单时原班次/房型无库存
    When 用户进入搜索页
    Then 系统显示替代方案并提示“原方案已售罄”

#### Scenario: 跳转失败或服务不可用（系统异常）

    Given 用户点击“重新下单”
    When 搜索服务不可用或跳转失败
    Then 页面提示“服务繁忙，请稍后重试”

#### Scenario: 用户在确认步骤中放弃取消 (输入异常)
> 正常流程，用户主动中止操作。

    Given 用户点击了“取消订单”，确认弹窗已出现
    When 用户点击“我再想想”按钮或关闭弹窗
    Then 弹窗应被关闭
    And 不会向后端发送任何请求
    And 订单状态保持不变

#### Scenario: 订单因状态限制不可被取消 (状态异常)
> 异常流程，后端校验发现订单状态已不支持取消。

    Given 用户正在查看一个“待出行”订单，但在他点击取消按钮前，该订单的状态已被系统自动变更为“已入住”
    When 用户点击“取消订单”并确认
    Then 后端服务应拒绝该请求，并返回“当前订单状态不支持取消”的错误信息
    And 前端应显示相应的失败提示，如：“操作失败，订单已无法取消”
    And 刷新页面数据，将“取消订单”按钮置灰

#### Scenario: 取消过程中系统出现未知错误 (系统异常)
> 系统异常，处理后端或第三方服务（如支付网关）的失败。

    Given 用户确认取消一个订单
    When 后端在处理取消逻辑时发生数据库错误或与供应商接口通信失败
    Then 后端应返回一个表示系统错误的响应
    And 前端应显示“系统繁忙，请稍后重试或联系客服”的错误提示
    And 订单状态保持不变，以便用户后续重试