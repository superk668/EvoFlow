# 机票预订需求文档

本文档旨在详细描述机票预订流程的核心功能、页面元素、用户交互及系统行为。

1. 航班搜索结果
    1.1 单程搜索结果页
        1.1.1 进入方式：
        - 从首页搜索卡提交“单程”条件后点击搜索进行跳转。
        - 刷新或分享带查询参数的 URL，保留筛选状态并重新加载列表。
        1.1.2 页面元素：
        - “出发地输入框”、“目的地输入框”、“出发日期选择器”。
        - 快捷筛选：`航空公司`、`起降时间`、`机型`、`舱位`、`更多`。
        - 航班卡片：`航空公司名称`、`航班号`、`起飞时间/机场/航站楼`、`到达时间/机场/航站楼`、`最低价`、`订票按钮`。
        - 套餐面板（展开后）：`套餐名称`、`价格`、`退改政策`、`行李额`、`预订按钮`。

        Scenario: 正常加载并展示航班列表
            Given 用户已登录且访问含有效查询参数的结果页
            When 系统向后端提交搜索请求
            Then 页面显示航班列表，卡片包含航司、航班号、起降时间与最低价
            And 展开套餐面板可见套餐明细与“预订”按钮

        Scenario: 输入异常（过去日期）
            Given 查询参数中的 `departDate` 为今天之前
            When 用户访问搜索结果页
            Then 系统拒绝请求或返回错误提示“不可选择过去日期”
            And 页面保持在本页并允许用户重新选择日期

        Scenario: 状态异常（未登录）
            Given 用户未登录
            When 用户打开搜索结果页或点击“预订”
            Then 系统跳转至登录页
            And 登录成功后回到结果页继续预订流程

        Scenario: 系统异常（搜索接口失败）
            Given 用户首次进入结果页
            When 搜索接口返回非 200 或网络异常
            Then 页面展示错误提示“搜索失败/网络异常，请稍后重试”
            And 保留筛选条件并提供继续浏览/重试入口

        Scenario: 状态异常（无可售结果）
            Given 查询条件有效但无库存
            When 搜索返回空列表
            Then 页面提示“暂无可售航班”并建议更换筛选条件

    1.2 预订入口（套餐面板）
        1.2.1 进入方式：
        - 在航班卡片点击“订票”展开套餐面板；点击某套餐的“预订”按钮进入订票页。
        1.2.2 页面元素：
        - 套餐卡片：`套餐名称`、`价格`、`退改`、`行李额`、`预订按钮`。

        Scenario: 正常选择套餐并进入订票页
            Given 用户在结果页展开某航班的套餐面板
            When 用户点击某套餐的“预订”按钮
            Then 系统保存所选航班与套餐到会话
            And 跳转至 `booking` 页面开始填写信息

        Scenario: 输入异常（套餐标识缺失）
            Given 用户点击“预订”时套餐 ID 缺失或无效
            When 系统尝试进入订票页
            Then 阻止跳转并提示“套餐信息异常，请重试”
            And 保持在当前结果页

        Scenario: 状态异常（价格变动）
            Given 用户停留超过5分钟后点击“预订”
            When 后端返回价格已更新
            Then 显示价格变更提示并要求用户确认
            And 用户确认后进入订票页，金额按最新价格计算

2. 订票页面（乘机人与联系人信息）
    2.1 填写乘机人与联系人
        2.1.1 进入方式：
        - 从结果页套餐的“预订”跳转至 `booking?flight=...&pkg=...`。
        2.1.2 页面元素：
        - 乘机人信息：`姓名输入框`、`证件类型下拉`（身份证/护照等）、`证件号输入框`、`国家/地区码下拉`、`乘机人手机（选填）`。
        - 联系人信息：`国家/地区码下拉`、`联系人手机号输入框`。
        - 操作：`下一步`按钮。

        Scenario: 正常填写并校验通过进入下一步
            Given 乘机人姓名非空且证件号合法
            And 联系人手机号合法
            When 用户点击“下一步”
            Then 系统保存乘机人与联系人信息到会话
            And 跳转至 `booking/services` 增值服务页

        Scenario: 输入异常（证件号格式错误）
            Given 证件类型为“身份证”
            When 用户输入不符合规则的身份证号
            Then 在证件号下方提示“证件号码格式不正确”
            And 阻止进入下一步

        Scenario: 输入异常（联系人手机号非法）
            Given 联系人国家/地区码为“中国 86”
            When 用户输入非 11 位合法手机号
            Then 在手机号输入框下方提示“联系人手机号格式不正确”
            And 阻止进入下一步

        Scenario: 系统异常（会话持久化失败）
            Given 用户点击“下一步”
            When 会话存储写入失败
            Then 页面提示“网络异常，请稍后重试”
            And 保留用户已填写的数据

3. 增值服务页面
    3.1 选择增值服务
        3.1.1 进入方式：
        - 从订票页点击“下一步”跳转至 `booking/services`。
        3.1.2 页面元素：
        - 增值服务选项（示例占位）：`行李额升级`、`延误险/取消险`、`值机提醒`。
        - 航班摘要与价格清单。
        - 操作：`下一步`按钮（进入支付）。

        Scenario: 正常选择服务进入支付
            Given 用户在服务页可选/不选任何服务
            When 用户点击“下一步”
            Then 跳转至 `booking/payment` 支付页
            And 已选服务计入价格清单

        Scenario: 状态异常（服务不可用）
            Given 某服务临时下线
            When 用户尝试勾选该服务
            Then 显示“服务暂不可用”并自动取消勾选

        Scenario: 系统异常（服务列表加载失败）
            Given 用户进入服务页
            When 服务数据加载失败
            Then 显示加载失败占位并允许继续至支付

4. 支付页面
    4.1 支付下单与倒计时
        4.1.1 进入方式：
        - 从服务页点击“下一步”进入 `booking/payment`。
        4.1.2 页面元素：
        - 金额摘要与航班信息；`剩余时间倒计时（15:00）`；`支付方式`（已保存银行卡/新卡）。
        - 新卡输入：`卡号`、`持卡人姓名`、`有效期`、`CVV`。
        - 操作：`支付按钮`（根据所选方式显示文案）。

        Scenario: 正常支付并进入完成页
            Given 用户选择“银行卡支付”或“新卡支付”
            And 倒计时未到期
            When 用户点击“支付”按钮
            Then 系统进入 `booking/complete` 完成页

        Scenario: 输入异常（新卡信息不完整）
            Given 用户选择“使用新卡支付”
            When 卡号/姓名/有效期/CVV 为空或格式错误
            Then 支付按钮保持不可用或提示“请填写完整且有效的卡信息”
            And 阻止进入完成页

        Scenario: 状态异常（倒计时到期）
            Given 倒计时归零
            When 用户停留在支付页
            Then 弹窗提示“超出时间，请重新开始订单”
            And 提供“返回首页”入口

        Scenario: 系统异常（支付请求失败）
            Given 用户点击“支付”
            When 支付服务不可用或网络异常
            Then 提示“支付失败，请稍后重试”
            And 保留支付页状态与输入数据

5. 完成页（出票成功）
    5.1 出票成功与订单创建
        5.1.1 进入方式：
        - 支付成功后跳转至 `booking/complete`。
        5.1.2 页面元素：
        - 订单信息卡：`金额`、`路线`、`起降信息`、`乘机人摘要`、`联系人`、`价格明细`。
        - 操作：`返回首页`。

        Scenario: 正常生成订单并展示完成页
            Given 用户已完成支付
            When 系统在完成页后台创建订单
            Then 返回 `订单号/状态/下单时间/总金额`
            And 完成页显示“成功出票”与订单摘要

        Scenario: 状态异常（重复创建防抖）
            Given 完成页副作用可能触发两次
            When 系统检测到创建锁或已有 `createdOrderId`
            Then 跳过重复创建
            And 页面仍显示完成信息

        Scenario: 系统异常（订单创建失败）
            Given 完成页触发订单创建
            When 后端返回错误或网络异常
            Then 页面保持完成展示但提示“订单创建失败，稍后查看订单中心”
            And 不影响已完成的支付与页面 UI

6. 订单中心
    6.1 订单列表
        6.1.1 进入方式：
        - 顶部导航或入口进入 `/orders`。
        6.1.2 页面元素：
        - 筛选：`全部/待出行/已取消/已完成`；类型：`全部订单/机票/火车票/酒店`。
        - 列表项：`订单号`、`标题`、`金额`、`状态`、`下单时间`、`动作（取消/下载）`。

        Scenario: 正常分页展示订单列表
            Given 用户已登录
            When 列表请求返回订单与分页信息
            Then 页面展示订单项与分页导航
            And 切换筛选或类型刷新列表

        Scenario: 状态异常（无订单）
            Given 用户无任何订单
            When 加载列表
            Then 显示“暂无订单”占位

        Scenario: 系统异常（列表加载失败）
            Given 用户进入订单列表页
            When 请求失败或超时
            Then 提示“加载失败”，提供重试按钮

    6.2 订单详情
        6.2.1 进入方式：
        - 从列表点击某订单进入 `/orders/:orderId`。
        6.2.2 页面元素：
        - `产品信息`、`旅客信息`、`联系信息`、`价格明细`、`操作（取消、下载）`。

        Scenario: 正常展示订单详情
            Given 用户访问某订单详情
            When 请求返回订单信息
            Then 页面展示产品信息与价格明细
            And 显示可用操作（如取消、下载）

        Scenario: 状态异常（权限不足）
            Given 用户尝试访问不属于自己的订单
            When 后端返回 403
            Then 页面提示“无权限查看该订单”并引导返回订单列表

        Scenario: 系统异常（订单不存在）
            Given 用户访问不存在的订单号
            When 后端返回 404
            Then 页面提示“订单不存在或已删除”

7. 全局购票进度条（Header）
    7.1 进度展示
        7.1.1 进入方式：
        - 在 `/booking/*` 路由展示进度条。
        7.1.2 页面元素：
        - 阶段：`1 乘机信息`、`2 增值服务`、`3 支付`、`4 完成`；当前阶段高亮，已完成显示“✓”。

        Scenario: 正常更新阶段状态
            Given 会话存储记录 `bookingStage`
            When 用户进入对应阶段页面
            Then 顶部进度条高亮当前阶段

        Scenario: 状态异常（阶段信息缺失）
            Given `bookingStage` 未写入或非法
            When 用户进入任一阶段
            Then 默认回退为第 1 阶段展示

        Scenario: 系统异常（会话读取失败）
            Given 用户进入任一阶段
            When 会话读取抛出异常
            Then 进度条保持默认显示且不影响页面交互

